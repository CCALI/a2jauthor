/*
	CALI Author 5 / A2J Author 5 (CAJA)
	All Contents Copyright The Center for Computer-Assisted Legal Instruction
	
	10/02/12 jQuery for CAJA - Custom minify of extra jQuery ui modules
	Included: jquery.xml.min.js, ui.traggable (dragging with Scale support)
	//SJG 1/22/13 - ui.traggable - setscale changed to absolute, drag item changed from .item to .node, added start/stop events
*/

/* jquery.xml.min.js  */
jQuery.fn.xml=function(all){var s="";if(this.length)
(((typeof all!='undefined')&&all)?this:jQuery(this[0]).contents()).each(function(){s+=window.ActiveXObject?this.xml:(new XMLSerializer()).serializeToString(this);});return s;};

/* combo box  */
 (function( $ ) {
$.widget( "ui.combobox", {
_create: function() {
var input,
that = this,
wasOpen = false,
select = this.element.hide(),
selected = select.children( ":selected" ),
value = selected.val() ? selected.text() : "",
wrapper = this.wrapper = $( "<span>" )
.addClass( "ui-combobox" )
.insertAfter( select );
function removeIfInvalid( element ) {
var value = $( element ).val(),
matcher = new RegExp( "^" + $.ui.autocomplete.escapeRegex( value ) + "$", "i" ),
valid = false;
select.children( "option" ).each(function() {
if ( $( this ).text().match( matcher ) ) {
this.selected = valid = true;
return false;
}
});
if ( !valid ) {
// remove invalid value, as it didn't match anything
$( element )
.val( "" )
.attr( "title", value + " didn't match any item" )
.tooltip( "open" );
select.val( "" );
setTimeout(function() {
input.tooltip( "close" ).attr( "title", "" );
}, 2500 );
input.data( "ui-autocomplete" ).term = "";
}
}
input = $( "<input>" )
.appendTo( wrapper )
.val( value )
.attr( "title", "" )
.addClass( "ui-state-default ui-combobox-input" )
.autocomplete({
delay: 0,
minLength: 0,
source: function( request, response ) {
var matcher = new RegExp( $.ui.autocomplete.escapeRegex(request.term), "i" );
response( select.children( "option" ).map(function() {
var text = $( this ).text();
if ( this.value && ( !request.term || matcher.test(text) ) )
return {
label: text.replace(
new RegExp(
"(?![^&;]+;)(?!<[^<>]*)(" +
$.ui.autocomplete.escapeRegex(request.term) +
")(?![^<>]*>)(?![^&;]+;)", "gi"
), "<strong>$1</strong>" ),
value: text,
option: this
};
}) );
},
select: function( event, ui ) {
ui.item.option.selected = true;
that._trigger( "selected", event, {
item: ui.item.option
});
},
change: function( event, ui ) {
if ( !ui.item ) {
removeIfInvalid( this );
}
}
})
.addClass( "ui-widget ui-widget-content ui-corner-left" );
input.data( "ui-autocomplete" )._renderItem = function( ul, item ) {
return $( "<li>" )
.append( "<a>" + item.label + "</a>" )
.appendTo( ul );
};
$( "<a>" )
.attr( "tabIndex", -1 )
.attr( "title", "Show All Items" )
.tooltip()
.appendTo( wrapper )
.button({
icons: {
primary: "ui-icon-triangle-1-s"
},
text: false
})
.removeClass( "ui-corner-all" )
.addClass( "ui-corner-right ui-combobox-toggle" )
.mousedown(function() {
wasOpen = input.autocomplete( "widget" ).is( ":visible" );
})
.click(function() {
input.focus();
// close if already visible
if ( wasOpen ) {
return;
}
// pass empty string as value to search for, displaying all results
input.autocomplete( "search", "" );
});
input.tooltip({
tooltipClass: "ui-state-highlight"
});
},
_destroy: function() {
this.wrapper.remove();
this.element.show();
}
});
})( jQuery );



/* Traggable */


/*!
* Adaption of jQuery Draggable:
*
* jQuery UI Draggable @VERSION
* http://jqueryui.com
*
* Copyright 2012 jQuery Foundation and other contributors
* Dual licensed under the MIT or GPL Version 2 licenses.
* http://jquery.org/license
*
* http://docs.jquery.com/UI/Draggables
*
* Depends:
* jquery.ui.core.js
* jquery.ui.mouse.js
* jquery.ui.widget.js
*/
(function($, undefined) {

    $.widget("ui.traggable", $.ui.mouse, {
        version: "1",
        widgetEventPrefix: "trag",
        options: {
            addClasses: true,
            appendTo: "parent",
            axis: false,
            connectToSortable: false,
            containment: false,
            cursor: "auto",
            cursorAt: false,
            grid: false,
            handle: false,
            helper: "original",
            iframeFix: false,
            opacity: false,
            refreshPositions: false,
            revert: false,
            revertDuration: 500,
            scope: "default",
            scroll: true,
            scrollSensitivity: 20,
            scrollSpeed: 20,
            snap: false,
            snapMode: "both",
            snapTolerance: 20,
            stack: false,
            zIndex: false,
            scaledParent: false,
            z: 1
        },
        _create: function() {
            this._mouseInit();
            this.z = this.options.z;
        },

        _destroy: function() {
            this._mouseDestroy();
        },

        _mouseCapture: function(event) {
            var o = this.options;
            this.eventCurrent = {
                x: event.pageX,
                y: event.pageY
            };
            return true;
        },

        _mouseStart: function(event) {

            this.target = $(event.target).closest('.node');//SJG 1/22/13
            return true;
        },

        _mouseDrag: function(event) {
            var dX = event.pageX,
                dY = event.pageY,
                velX = (this.eventCurrent.x - event.pageX),
                velY = (this.eventCurrent.y - event.pageY);
            this._moveItem(this.target, velX, velY);
            this.eventCurrent = {
                x: event.pageX,
                y: event.pageY
            };
            return true;
        },

        _mouseStop: function(event) {
		  
			//SJG 1/22/13
			if(this._trigger("stop", event,{node:this.target,position:{left:parseFloat(this.target.css('left')),top:parseFloat(this.target.css('top'))}}) !== false) {
				}
				
            return false;
        },

        _mouseUp: function(event) {
            return $.ui.mouse.prototype._mouseUp.call(this, event);
        },

        _moveItem: function(target, x, y) {
            var position = {
                left: parseFloat(target.css('left')),
                top: parseFloat(target.css('top'))
            };
            if(isNaN(position.left)){
                position.left = target.offset().left;
            }
            if(isNaN(position.top)){
                position.top = target.offset().top;
            }
            x = x * (1 / this.z);
            y = y * (1 / this.z);
            target.css({
                'left': position.left - x,
                'top': position.top - y
            });
        },
        changeScale: function(dZ){
            this.z =dZ;//SJG 1/22/13 this.z + dZ;
            var scale = "scale(" + this.z + ")";
            console.log(scale);
            this.element.css({
                "-webkit-transform":scale,
                "-moz-transform": scale,
                "-ms-transform": scale,
                "-o-transform": scale,
                "transform": scale,
            });
        }

    });

})(jQuery);
