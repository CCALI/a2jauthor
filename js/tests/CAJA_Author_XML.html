<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--
	CALI Author 5 / A2J Author 5 (CAJA)
	All Contents Copyright The Center for Computer-Assisted Legal Instruction
-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>CAJA Author XML</title>

<script src="../jquery.1.8.2.min.js" type="text/javascript"></script>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script> 
$(document).ready(function()
{  
	trace("Ready");
	loadFile(""+
			//"data/Field Characters Test.a2j"
			"data/A2J_ULSOnlineIntake081611_Interview.xml"
			//"data/A2J_FieldTypesTest_Interview.xml"
			//"data/CBK_CAPAGETYPES_jqBookData.xml"
			//"data/CBK_EVD03_jqBookData.xml"
		); 

	$("ul.testunits li a").each(function(){
		loadFile($(this).attr('href')); 
	});
});
//traceScript=trace=function(msg){	$('.ScriptTrace').append('<li>'+  Array.prototype.slice.call(arguments).join(", ")); }
function loadFile(bookFile)
{
	trace("Loading XML "+bookFile);
	$.ajax({
			url: bookFile,
			dataType: "text"  , // IE will only load XML file from local disk as text, not xml.
			timeout: 45000,
			error: function(data,textStatus,thrownError){
			  alert('Error occurred loading from '+this.url+"\n"+textStatus);
			 },
			success: function(data){
				parseFile(data);
			}
		});
} 
function parseFile(xml_str)
{ 	
	var guide1;
	var guide2;
	var json1;
	var json2;
	
	if (  0 ){
		guide = blankGuide();
		xml_str = exportXML_CAJA_from_CAJA(guide);
		trace(htmlEscape(xml_str));
	}else{	
		// Read old file format's XML.
		trace('Guide imported from arbitrary XML');
		var dataXML=$(jQuery.parseXML(xml_str));
		guide1=  parseXML_Auto_to_CAJA( dataXML );
	}
	trace(guide1.title);
	
	if ( 1 )
	{
		//guide.pages = guide.sortedPages; 
		var save=guide1.sortedPages; guide1.sortedPages ="HIDDEN"; json1=propsJSON('Guide', guide1); guide1.sortedPages=save;
		//trace('<blockquote>'+json1+'</blockquote>');
	}
	
	// Convert to CAJA XML
	trace('Guide exported to CAJA XML');
	var cajaDataXML1_str = exportXML_CAJA_from_CAJA(guide1);		cajaDataXML1_str = cajaDataXML1_str.replace("<P></P>","<P/>");//
	console.log(cajaDataXML1_str);
	
	// Readin CAJA XML 
	guide2=  parseXML_Auto_to_CAJA($(jQuery.parseXML(cajaDataXML1_str)));
	trace('Guide imported from CAJA XML');
	trace(guide2.title);
	
	var cajaDataXML2_str = exportXML_CAJA_from_CAJA(guide2);		cajaDataXML2_str = cajaDataXML2_str.replace("<P></P>","<P/>");//

	trace('Comparing XML structure');
	var i;
	for (i=0;i<cajaDataXML1_str.length;i++)
		if (cajaDataXML1_str.substr(i,1)!=cajaDataXML2_str.substr(i,1))
			break;
	if (cajaDataXML2_str==cajaDataXML1_str)
		trace("XML's match");
	else
	{
		trace("<h1>XML MISMATCH at "+i+"</h1>");
		i=Math.max(i-100,0);
		//trace(htmlEscape(cajaDataXML_str.substr(Math.max(0,i-100),200)));
		//trace("1="+  htmlEscape(cajaDataXML_str.substr(i,200)));
		//trace("2="+  htmlEscape(cajaDataXML2_str.substr(i,200)));
		//trace('<hr><blockquote>'+htmlEscape(cajaDataXML_str)+'</blockquote><hr>');	//trace('<pre>'+htmlEscape(cajaDataXML_str)+'</pre>');
		trace('<table border=5><tr valign=top>'+
			'<td style="font-family: Monospace;" width=50%>'+htmlEscape(cajaDataXML1_str.substr(i,200))+'</td>'+
			'<td style="font-family: Monospace;" width=50%>'+htmlEscape(cajaDataXML2_str.substr(i,200))+'</td></tr></table>');
	} 
	if (0){
	//guide2.pages = guide2.sortedPages;
	guide2.sortedPages="HIDDEN";
	var json2=propsJSON('Guide', guide2);
	//trace('Guide imported from CAJA XML is: <blockquote>'+json2+'</blockquote>');
	trace('<hr><blockquote>'+htmlEscape(cajaDataXML2_str)+'</blockquote><hr>');	//trace('<pre>'+htmlEscape(cajaDataXML_str)+'</pre>');
	}
	
if ( 0 ){
	trace('Comparing JSON structure: ' + (json1 == json2));
	for (i=0;i<json1.length;i++)
		if (json1.substr(i,1)!=json2.substr(i,1))
			break;
	i=Math.max(i-500,0);
	trace("<h1>XML MISMATCH at "+i+"</h1>");
	trace("<table ><tr valign=top><td width=50%>"+json1.substr(i,510)+"</td><td width=50%>"+json2.substr(i,510)+"</td></tr></table>");
}
	
	trace('<hr>XML of cajaDataXML1_str<blockquote>'+htmlEscape(cajaDataXML1_str)+'</blockquote><hr>');
	trace('<hr>XML of cajaDataXML2_str<blockquote>'+htmlEscape(cajaDataXML2_str)+'</blockquote><hr>');
}

</script>
<script src="../jquery.ui.1.9.0.min.js" type="text/javascript"></script>
<link  href="../jquery.ui.custom.css" rel="stylesheet" type="text/css" />
<script src="../jquery.ui.custom.min.js" type="text/javascript" ></script>
<script src="../CAJA_Types.js" type="text/javascript"></script>
<script src="../CAJA_Utils.js" type="text/javascript"></script>
<script src="../CAJA_Languages.js" type="text/javascript"></script>
<script src="../CAJA_Parser.js" type="text/javascript"></script>
<script src="../CAJA_Parser_CA.js" type="text/javascript"></script>
<script src="../CAJA_Parser_A2J.js" type="text/javascript"></script>
<script src="../CAJA_Dev.js" type="text/javascript"></script>

<style type="text/css">
<!--
.json.indent {
	margin-left:1em;
	text-indent: -2em;
}

-->
</style>
</head>
<body >
<div id="tracer" class="ScriptTrace"></div>
</body>
</html>
