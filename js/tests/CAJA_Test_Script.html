<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<!-- DW6 -->
<HEAD>
<LINK REL="shortcut icon" HREF="file:///F|/img/CALILogoSJG.ico" TYPE="image/x-icon" />

<title>CALI Author Script Tester</title> 

<script src="../jQuery/jquery-1.7.2.min.js" type="text/javascript"></script>
<script src="../jQuery/jshashtable-2.1.js" type="text/javascript"></script>
<script src="../jQuery/jquery.numberformatter-1.2.1.jsmin.js" type="text/javascript"></script>
<script src="../CAJA_Utils.js" type="text/javascript"></script>
<script src="../CAJA_Languages.js" type="text/javascript"></script>
<script xsrc="js/CAJA_Script.js" type="text/javascript"></script>
<script src="../CAJA_Script_to_JS.js" type="text/javascript"></script>

<script>

var testunit={}
function parseUnit(unitText)
{ 
	// Load a test unit file. Create fake pages from @Page and @Var lines
	var lines=unitText.split("\n");
	var curpage=null;
	for (var l=0;l<lines.length;l++)
	{	// Extract variables and page names and attach scripts to pages
		var line=jQuery.trim(lines[l]).split("//")[0];
		if ((args = line.match(/@page\s+(\w[\w|\s]+)/i))!=null)
		{
			var pageName = args[1];
			testunit.pages[pageName.toLowerCase()] = { name:pageName, lines:[]};
			curpage= testunit.pages[pageName.toLowerCase()];
			testunit.trace("Define page "+pageName);
		}
		else
		if ((args = line.match(/@var\s+(\w[\w|\s]+)/i))!=null)
		{
			var varName = args[1];
			testunit.trace("Define variable "+varName);
			testunit.setVar(varName,0,"");
//			testunit.vars[varName.toLowerCase()] = { name:varName, len:0, elts:[]};
		}
		else
		//if (line!="")
			if (curpage!=null)
				curpage.lines.push(lines[l]);
	}
	delete lines;
	
	// Parse the syntax of each page's scripts
	for (var p in testunit.pages)
	{
		var page=testunit.pages[ p ];
		var lines = page.lines; 
		testunit.trace("<hr>");
		testunit.trace("<h1>Script for page "+page.name+'</h1>'); 
		testunit.indent++;
		var script = _GCS.translateCAJAtoJS(lines.join("\n"));
		//alert(lines.join("\n"));
		if (script.errors.length>0)
		{
			testunit.trace("CAJAScript Script");
			testunit.indent++;
			for (l=0;l<lines.length;l++)
			{
				var err=null;
				for (var e in script.errors)
					if (script.errors[e].line == l)
						err=script.errors[e];
				if (err == null)
					testunit.trace(lines[l]);
				else
				{
					testunit.trace("<font color=red>"+lines[l]+"</font>");
				}
			}
			testunit.indent--;
			testunit.trace("CAJAScript has errors");
			testunit.indent++;
			for (var e in script.errors)
			{
				err=script.errors[e];
				testunit.trace("<b>"+err.line+":"+err.text+"</b>");
			}
			testunit.indent--;
		}
		else
		{
			testunit.trace("CAJAScript Evaluate");
			testunit.indent++;
			for (l=0;l<lines.length;l++)
			{
				testunit.trace(lines[l]);
			}
			testunit.indent--;
			testunit.trace("Javascript");
			testunit.indent++;
			for (l=0;l<script.js.length;l++)
			{
				testunit.trace(script.js[l]);
			}
			testunit.indent--;
			//}}}}}}}}}}}}} TODO use JS to eval for syntax errors!
			
			testunit._VS=testunit.setVar;//function(v){ testunit.trace("SET VAR "+v);}
			testunit._VG=testunit.getVar;//function(v){ testunit.trace("SET VAR "+v);}
			testunit._CF=function(f){ testunit.trace("Call function "+f); return 0;}
			testunit._ED=function(f){ return 0;}
			testunit._GO=function(pageName){ testunit.pageName=pageName;testunit.trace("Going to page "+pageName);}
			testunit._deltaVars=testunit.deltaVars;
			var js = "with (testunit) {"+ script.js.join("\n") +"}";
			//var js = 'with (testunit) { _VS("name",55); _VS("first",22); }';
			//testunit.trace(js);

			try {
				var f=(new Function( js ));
				var result = f();//execute the javascript code.
//				testunit.trace(f());
//				eval(js);
			}
			catch (e) { 
				testunit.trace("ERROR: " +e.message +" " + e.lineNumber);
			}
			
		}
		testunit.indent--;
	}
}




traceScript=trace=function(msg)
{
	$('.ScriptTrace').append('<li>'+  Array.prototype.slice.call(arguments).join(", ")); 
}
$(document).ready(function()
{  

	trace("Ready");
	
	
alert('hi')
var childInterface = document.getElementById("AIRSandBox").childSandboxBridge;
//alert(childInterface.info())

	
//	testunit.traceDepth=0;
	testunit.trace=function(msg){
		var nbsp="";for (var i=0;i<3*this.indent;i++){nbsp+="&nbsp;";}$('.ScriptTrace').append( nbsp + Array.prototype.slice.call(arguments).join(", ")+"<br>");};
//	testunit.traceIndent=function(delta){ this.traceDepth+=delta;}
	testunit.indent=0;
	testunit.pageName="";
	testunit.vars={}
	testunit.varsOld={};
	testunit.pages={};
	$("ul.testunits li a").each(function(){
		loadFile($(this).attr('href')); 
	//	loadFile("CAJA_Test_Script_Unit1.txt"); 
	});
});

function loadFile(bookFile)
{
	trace("Loading Unit Test "+bookFile);
	$.ajax({
			url: bookFile,
			dataType: "text"  , // IE will only load XML file from local disk as text, not xml.
			timeout: 45000,
			error: function(data,textStatus,thrownError){
			  alert('Error occurred loading from '+this.url+"\n"+textStatus);
			 },
			success: function(data){
				parseUnit(data);
			}
		});
} 
function scriptTag(cname,chtml){return "<span class=script_"+cname+">"+chtml+"</span>";}



testunit.setVar=function(varName,varIndex,varVal)
{
	if (varIndex==null || varIndex=='') varIndex=0;
	this.trace('Set '+scriptTag('var',varName)+' to '+varVal);
	var varName_i=varName.toLowerCase();
	var v=testunit.vars[varName_i];
	if (typeof v == 'undefined')
	{
		v={name:varName,values:[]};
		testunit.vars[varName_i]=v;
	}
	if (typeof testunit.varsOld[varName_i+"."+varIndex]=='undefined')
		testunit.varsOld[varName_i+"."+varIndex]=[v.values[varIndex]];
//	testunit.varsOld[varName_i+"."+varIndex].push(v.values[varIndex]);
	v.values[varIndex]=varVal; 
}
testunit.getVar=function(varName,varIndex)
{
	//this.trace('Get '+scriptTag('var',varName));
	if (varIndex==null || varIndex=='') varIndex=0;
	var varName_i=varName.toLowerCase();
	var v=testunit.vars[varName_i];
	if (typeof v == 'undefined')
		return 'undefined';
	else
		return v.values[varIndex]; 
}
testunit.deltaVars=function()
{	// Display variables indicating changed/new.
	var html='<table   border="2"  cellpadding="1" cellspacing="0"><tr><th nowrap="nowrap" class="colVar">Variable</th><th nowrap="nowrap" class="colIndex">Index</th><th nowrap="nowrap" class="colValue">Value</th><th  class="colValue">Old Value</th></tr>';

	//trace(props(testunit.varsOld));

	for (var varName_i in this.vars)
	{
		var v = this.vars[varName_i]
		var varName=v.name;
		for (var vi=0;vi<v.values.length;vi++)
		{
			var stat=""; 
			var varVal=v.values[vi];
			var vOld=this.varsOld[varName_i+"."+vi];
			if (typeof vOld!="undefined")
			{
				html += '<tr rel="'+varName_i+'"><td class="colVar">'+varName+'</td><td class="colIndex">'+vi+'</td><td class="colValue '+''+'">'+varVal+'</td><td class="colValue">'+vOld.join(" , ")+'</td></tr>';
			}
			}
	}
	html+='</table><br>';
	this.trace(html);
	
	this.varsOld={}; 
}

testunit.evalExpression = function(expr)
{
/*
	*/
}
testunit.evalBlock=function(block)
{
	return this.evalExpression(block);
}
testunit.evalHTML=function(html)
{	// Parse for %% declarations.
	var parts=html.split("%%");
	if (parts.length > 0)
	{
		html="";
		for (var p=0;p<parts.length;p+=2)
		{
			html += parts[p];
			if (p<parts.length-1)
			{
				html += this.evalBlock(parts[p+1]);
			}
		}
	}
	return html;
}

</script>


<style type="text/css">
<!--
Body {
	font-family: Verdana, Arial, Helvetica, sans-serif;
}
P.Script, LI.Script, BlockQuote.Script {
	border: thin solid #CC9966;
	background-color: #efe;
	margin: 2px;
	padding: 3px;
}
.Script {
	font-weight: normal;
	font-family: "Courier New", Courier, monospace;
	font-size: 12px;
	color: #00f;
}
.Script B {
	font-weight: bold;
	font-family: "Courier New", Courier, monospace;
	color: #093;
}
.Script I {
	font-weight: italic;
	font-family:  Arial, Helvetica, sans-serif;
	color: #999999;
}

.ScriptTrace{
	font-weight: normal;
	font-family: "Courier New", Courier, monospace;
	height: 100%;
	font-size: 8pt; 
	xoverflow: scroll;
	border: thin solid #CC9966;
	background-color: #CCFFCC;
	xmargin: 1px;
	xpadding: 2px;
}
.ScriptVariables table tr td{
	border: thin solid #CC9966;
	background-color: #CCFFCC;
	font-size: 8pt; 
	margin: 1px;
	padding: 2px;
}
.Macro {
	border: thin solid #CC9966;
	background-color: #CCFFCC;
	padding: 15px;
	font-size: smaller;
	
}
.ScriptErr{
	font-weight: bold;
	color: #FF0000;
}
th {
	font-weight: normal;
}
td.colVar {
	color:#022;
}
td.colIndex {
	color:#220;
}
td.colValue {
	color:#202;
}
td.varnew {
	color:#080;
}
td.varsame {
	color:#000;
}
td.vardiff {
	color:#800;
}

#samplescripts a {
}
-->
</style>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></HEAD>


<BODY BGCOLOR="#FFFFFF"  >
<h1>CAJA - CALI Author/A2J Author Script Tester</h1>
<p>5/15/2012 updated | <a href="../CAJA_Script.js">CAJA_Script.js</a>|  
<a href="../../CAJA_Script_Notes.html">Development Notes</a></p>
<p>Scripts to test: </p>
<ul class="testunits">
	<li><a href="CAJA_Test_Script_Unit1.txt">CAJA_Test_Script_Unit1.txt</a></li>
</ul>
<div class="ScriptTrace"></div>
<ol class="ScriptTrace1"></ol>
		<div class="evaluator"><input name="lessontitle" style="width:100%" type="text" id="lessontitle" value="(1+2)=(3-1)" size="40" />
			<input onclick="update()" type="submit" name="evaluate" id="evaluate" value="Evaluate" /></div> 

<p>&nbsp;</p>
		<P>&nbsp;</P>

<iframe id="AIRSandBox" src="CAJA_AIR_Script.html" sandboxRoot="http://www.cali.org" documentRoot="app://sandbox/"></iframe>
</BODY>
</HTML>

